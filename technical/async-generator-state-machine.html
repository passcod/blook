<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>2018 | A little elegant state machine with Async Generators - Félix Saparelli</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../intro.html"><strong aria-hidden="true">1.</strong> Introduction</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../avatars/index.html"><strong aria-hidden="true">1.1.</strong> Avatars</a></li><li class="chapter-item "><a href="../info/index.html"><strong aria-hidden="true">1.2.</strong> Pronouns</a></li><li class="chapter-item "><a href="../info/trademark.html"><strong aria-hidden="true">1.3.</strong> Trademark</a></li></ol></li><li class="chapter-item expanded "><a href="../technical/index.html"><strong aria-hidden="true">2.</strong> Technicals</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../technical/g7-7700-nouveau.html"><strong aria-hidden="true">2.1.</strong> 2024 | Nouveau on Dell G7 7700</a></li><li class="chapter-item "><a href="../technical/caddy.html"><strong aria-hidden="true">2.2.</strong> 2023 | Caddy</a></li><li class="chapter-item "><a href="../technical/starlink.html"><strong aria-hidden="true">2.3.</strong> 2023 | IPv6 on Mikrotik on Starlink</a></li><li class="chapter-item "><a href="../technical/just-a-bit-of-wasi.html"><strong aria-hidden="true">2.4.</strong> 2022 | Just a bit of wasi</a></li><li class="chapter-item "><a href="../technical/rust-crimes-enum-ints.html"><strong aria-hidden="true">2.5.</strong> 2021 | Rust crimes: Enum ints</a></li><li class="chapter-item "><a href="../technical/exploring-wasm.html"><strong aria-hidden="true">2.6.</strong> 2020 | Exploration of Wasm</a></li><li class="chapter-item expanded "><a href="../technical/async-generator-state-machine.html" class="active"><strong aria-hidden="true">2.7.</strong> 2018 | A little elegant state machine with Async Generators</a></li></ol></li><li class="chapter-item expanded "><a href="../musings/index.html"><strong aria-hidden="true">3.</strong> Musings</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../musings/progression-of-designs.html"><strong aria-hidden="true">3.1.</strong> A progression of designs</a></li><li class="chapter-item "><a href="../musings/gaston-lagaffe/index.html"><strong aria-hidden="true">3.2.</strong> Gaston Lagaffe</a></li><li class="chapter-item "><a href="../musings/known-unknowns-conflang.html"><strong aria-hidden="true">3.3.</strong> Known Unknowns: a configuration language</a></li><li class="chapter-item "><a href="../musings/on-the-difficulty-of-automated-unblocking.html"><strong aria-hidden="true">3.4.</strong> On the difficulty of automated unblocking</a></li><li class="chapter-item "><a href="../musings/on-invoking-deities.html"><strong aria-hidden="true">3.5.</strong> On Invoking Deities</a></li></ol></li><li class="chapter-item expanded "><a href="../models/index.html"><strong aria-hidden="true">4.</strong> 3D Models</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../models/wall-plant-pots/index.html"><strong aria-hidden="true">4.1.</strong> Wall Plant Pots</a></li><li class="chapter-item "><a href="../models/mijia-hang/index.html"><strong aria-hidden="true">4.2.</strong> Mijia Hang</a></li><li class="chapter-item "><a href="../models/filabox/index.html"><strong aria-hidden="true">4.3.</strong> Filabox</a></li></ol></li><li class="chapter-item expanded "><a href="../fiction/index.html"><strong aria-hidden="true">5.</strong> Fiction</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../fiction/poetry/index.html"><strong aria-hidden="true">5.1.</strong> Poetry</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../fiction/poetry/only-one-left.html"><strong aria-hidden="true">5.1.1.</strong> Only One Left</a></li><li class="chapter-item "><a href="../fiction/poetry/mid-loss.html"><strong aria-hidden="true">5.1.2.</strong> Mid-loss</a></li><li class="chapter-item "><a href="../fiction/poetry/aftermath.html"><strong aria-hidden="true">5.1.3.</strong> Aftermath</a></li><li class="chapter-item "><a href="../fiction/poetry/one-and-two.html"><strong aria-hidden="true">5.1.4.</strong> one and two</a></li><li class="chapter-item "><a href="../fiction/poetry/grow.html"><strong aria-hidden="true">5.1.5.</strong> Grow</a></li><li class="chapter-item "><a href="../fiction/poetry/slowly.html"><strong aria-hidden="true">5.1.6.</strong> Slowly</a></li><li class="chapter-item "><a href="../fiction/poetry/alya.html"><strong aria-hidden="true">5.1.7.</strong> Alya</a></li><li class="chapter-item "><a href="../fiction/poetry/so-many-alone-at-night.html"><strong aria-hidden="true">5.1.8.</strong> so many alone at night</a></li><li class="chapter-item "><a href="../fiction/poetry/up-up-and-away.html"><strong aria-hidden="true">5.1.9.</strong> Up Up And Away</a></li><li class="chapter-item "><a href="../fiction/poetry/sleep.html"><strong aria-hidden="true">5.1.10.</strong> Sleep</a></li><li class="chapter-item "><a href="../fiction/poetry/hold.html"><strong aria-hidden="true">5.1.11.</strong> Hold</a></li><li class="chapter-item "><a href="../fiction/poetry/sorry.html"><strong aria-hidden="true">5.1.12.</strong> Sorry</a></li><li class="chapter-item "><a href="../fiction/poetry/right-over-there.html"><strong aria-hidden="true">5.1.13.</strong> Right over there</a></li><li class="chapter-item "><a href="../fiction/poetry/the-road-to-hell.html"><strong aria-hidden="true">5.1.14.</strong> The Road to Hell</a></li><li class="chapter-item "><a href="../fiction/poetry/self.html"><strong aria-hidden="true">5.1.15.</strong> Self</a></li><li class="chapter-item "><a href="../fiction/poetry/tree.html"><strong aria-hidden="true">5.1.16.</strong> Tree</a></li><li class="chapter-item "><a href="../fiction/poetry/unlit.html"><strong aria-hidden="true">5.1.17.</strong> Unlit</a></li><li class="chapter-item "><a href="../fiction/poetry/one-summer-morning.html"><strong aria-hidden="true">5.1.18.</strong> One summer morning</a></li><li class="chapter-item "><a href="../fiction/poetry/smile.html"><strong aria-hidden="true">5.1.19.</strong> Smile</a></li></ol></li><li class="chapter-item "><a href="../fiction/shorts/index.html"><strong aria-hidden="true">5.2.</strong> Short Prose</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../fiction/shorts/the-box.html"><strong aria-hidden="true">5.2.1.</strong> The Box</a></li><li class="chapter-item "><a href="../fiction/shorts/a-man.html"><strong aria-hidden="true">5.2.2.</strong> A Man</a></li><li class="chapter-item "><a href="../fiction/shorts/alive-in-the-night.html"><strong aria-hidden="true">5.2.3.</strong> ali.vei.nth.eni.ght</a></li><li class="chapter-item "><a href="../fiction/shorts/regulus.html"><strong aria-hidden="true">5.2.4.</strong> Regulus</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../fiction/shorts/regulus-notes.html"><strong aria-hidden="true">5.2.4.1.</strong> (notes for) Regulus</a></li></ol></li><li class="chapter-item "><a href="../fiction/shorts/my-mountain-of-knowledge.html"><strong aria-hidden="true">5.2.5.</strong> My mountain of Knowledge</a></li><li class="chapter-item "><a href="../fiction/shorts/finally-i-knew.html"><strong aria-hidden="true">5.2.6.</strong> Finally, I knew</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../recipes/index.html"><strong aria-hidden="true">6.</strong> Recipes</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../recipes/blue-orange.html"><strong aria-hidden="true">6.1.</strong> Blue Orange Cocktail</a></li><li class="chapter-item "><a href="../recipes/thermomix/dairy-cream.html"><strong aria-hidden="true">6.2.</strong> No-effort Dairy Cream</a></li><li class="chapter-item "><a href="../recipes/thermomix/pasta.html"><strong aria-hidden="true">6.3.</strong> Semi-steamed Pasta</a></li></ol></li><li class="chapter-item expanded "><a href="../updates/index.html"><strong aria-hidden="true">7.</strong> Progress updates</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../updates/projects/sassbot.html"><strong aria-hidden="true">7.1.</strong> Sassbot</a></li><li class="chapter-item "><a href="../updates/projects/spanish.html"><strong aria-hidden="true">7.2.</strong> Spanish</a></li><li class="chapter-item "><a href="../updates/projects/super.html"><strong aria-hidden="true">7.3.</strong> Super</a></li><li class="chapter-item "><a href="../updates/projects/cargo-watchexec.html"><strong aria-hidden="true">7.4.</strong> Watchexec</a></li><li class="chapter-item "><div><strong aria-hidden="true">7.5.</strong> Archived</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../updates/projects/accord.html"><strong aria-hidden="true">7.5.1.</strong> Accord</a></li><li class="chapter-item "><a href="../technical/agile/index.html"><strong aria-hidden="true">7.5.2.</strong> AGILE</a></li><li class="chapter-item "><a href="../updates/projects/armstrong.html"><strong aria-hidden="true">7.5.3.</strong> Armstrong</a></li><li class="chapter-item "><a href="../updates/projects/caretaker.html"><strong aria-hidden="true">7.5.4.</strong> Caretaker</a></li><li class="chapter-item "><a href="../updates/projects/car-rainbow.html"><strong aria-hidden="true">7.5.5.</strong> Car Rainbow</a></li><li class="chapter-item "><a href="../updates/projects/certainly.html"><strong aria-hidden="true">7.5.6.</strong> Certainly</a></li><li class="chapter-item "><a href="../updates/projects/ct.html"><strong aria-hidden="true">7.5.7.</strong> ct</a></li><li class="chapter-item "><a href="../updates/projects/defnew.html"><strong aria-hidden="true">7.5.8.</strong> defnew</a></li><li class="chapter-item "><a href="../updates/projects/eqsky.html"><strong aria-hidden="true">7.5.9.</strong> Earthquake Sky</a></li><li class="chapter-item "><a href="../updates/projects/figleaf.html"><strong aria-hidden="true">7.5.10.</strong> Figleaf</a></li><li class="chapter-item "><a href="../updates/projects/glass-hanger.html"><strong aria-hidden="true">7.5.11.</strong> Glass Hanger</a></li><li class="chapter-item "><a href="../updates/projects/entry-insert.html"><strong aria-hidden="true">7.5.12.</strong> Hashmap Entry Insert</a></li><li class="chapter-item "><a href="../updates/projects/intpath.html"><strong aria-hidden="true">7.5.13.</strong> IntPath</a></li><li class="chapter-item "><a href="../updates/projects/irish.html"><strong aria-hidden="true">7.5.14.</strong> Irish</a></li><li class="chapter-item "><a href="../updates/projects/japanese.html"><strong aria-hidden="true">7.5.15.</strong> Japanese</a></li><li class="chapter-item "><a href="../updates/projects/keycasting.html"><strong aria-hidden="true">7.5.16.</strong> Keycasting</a></li><li class="chapter-item "><a href="../updates/projects/lah-kara.html"><strong aria-hidden="true">7.5.17.</strong> Lah Kara</a></li><li class="chapter-item "><a href="../updates/projects/mead.html"><strong aria-hidden="true">7.5.18.</strong> Mead</a></li><li class="chapter-item "><a href="../updates/projects/notify.html"><strong aria-hidden="true">7.5.19.</strong> Notify</a></li><li class="chapter-item "><a href="../updates/projects/omelette.html"><strong aria-hidden="true">7.5.20.</strong> Omelette</a></li><li class="chapter-item "><a href="../updates/projects/pinn.html"><strong aria-hidden="true">7.5.21.</strong> Pinn</a></li><li class="chapter-item "><a href="../updates/projects/reasonable.html"><strong aria-hidden="true">7.5.22.</strong> Reasonable</a></li><li class="chapter-item "><a href="../updates/projects/reupholstery.html"><strong aria-hidden="true">7.5.23.</strong> Reupholstering chairs</a></li><li class="chapter-item "><a href="../updates/projects/splash.html"><strong aria-hidden="true">7.5.24.</strong> Splash</a></li><li class="chapter-item "><a href="../updates/projects/storq.html"><strong aria-hidden="true">7.5.25.</strong> Storq</a></li><li class="chapter-item "><a href="../updates/projects/swp.html"><strong aria-hidden="true">7.5.26.</strong> Swp</a></li><li class="chapter-item "><a href="../updates/projects/trebuchet.html"><strong aria-hidden="true">7.5.27.</strong> Trebuchet</a></li><li class="chapter-item "><a href="../updates/projects/what.html"><strong aria-hidden="true">7.5.28.</strong> What</a></li><li class="chapter-item "><a href="../updates/projects/zarc.html"><strong aria-hidden="true">7.5.29.</strong> Zarc</a></li></ol></li><li class="chapter-item "><a href="../updates/dated/index.html"><strong aria-hidden="true">7.6.</strong> 2017-2019 (mostly) regular micro updates</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../updates/dated/2016.html"><strong aria-hidden="true">7.6.1.</strong> 2016</a></li><li class="chapter-item "><a href="../updates/dated/2017/index.html"><strong aria-hidden="true">7.6.2.</strong> 2017</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../updates/dated/2017/january.html"><strong aria-hidden="true">7.6.2.1.</strong> January</a></li><li class="chapter-item "><a href="../updates/dated/2017/february.html"><strong aria-hidden="true">7.6.2.2.</strong> February</a></li><li class="chapter-item "><a href="../updates/dated/2017/march.html"><strong aria-hidden="true">7.6.2.3.</strong> March</a></li><li class="chapter-item "><a href="../updates/dated/2017/april.html"><strong aria-hidden="true">7.6.2.4.</strong> April</a></li><li class="chapter-item "><a href="../updates/dated/2017/may.html"><strong aria-hidden="true">7.6.2.5.</strong> May</a></li><li class="chapter-item "><a href="../updates/dated/2017/june.html"><strong aria-hidden="true">7.6.2.6.</strong> June</a></li><li class="chapter-item "><a href="../updates/dated/2017/july.html"><strong aria-hidden="true">7.6.2.7.</strong> July</a></li><li class="chapter-item "><a href="../updates/dated/2017/august.html"><strong aria-hidden="true">7.6.2.8.</strong> August</a></li><li class="chapter-item "><a href="../updates/dated/2017/september.html"><strong aria-hidden="true">7.6.2.9.</strong> September</a></li><li class="chapter-item "><a href="../updates/dated/2017/october.html"><strong aria-hidden="true">7.6.2.10.</strong> October</a></li><li class="chapter-item "><a href="../updates/dated/2017/november.html"><strong aria-hidden="true">7.6.2.11.</strong> November</a></li><li class="chapter-item "><a href="../updates/dated/2017/december.html"><strong aria-hidden="true">7.6.2.12.</strong> December</a></li></ol></li><li class="chapter-item "><a href="../updates/dated/2018/index.html"><strong aria-hidden="true">7.6.3.</strong> 2018</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../updates/dated/2018/january.html"><strong aria-hidden="true">7.6.3.1.</strong> January</a></li><li class="chapter-item "><a href="../updates/dated/2018/march.html"><strong aria-hidden="true">7.6.3.2.</strong> March</a></li><li class="chapter-item "><a href="../updates/dated/2018/april.html"><strong aria-hidden="true">7.6.3.3.</strong> April</a></li><li class="chapter-item "><a href="../updates/dated/2018/may.html"><strong aria-hidden="true">7.6.3.4.</strong> May</a></li><li class="chapter-item "><a href="../updates/dated/2018/september.html"><strong aria-hidden="true">7.6.3.5.</strong> September</a></li><li class="chapter-item "><a href="../updates/dated/2018/november.html"><strong aria-hidden="true">7.6.3.6.</strong> November</a></li><li class="chapter-item "><a href="../updates/dated/2018/december.html"><strong aria-hidden="true">7.6.3.7.</strong> December</a></li></ol></li><li class="chapter-item "><a href="../updates/dated/2019/index.html"><strong aria-hidden="true">7.6.4.</strong> 2019</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../updates/dated/2019/january.html"><strong aria-hidden="true">7.6.4.1.</strong> January</a></li><li class="chapter-item "><a href="../updates/dated/2019/february.html"><strong aria-hidden="true">7.6.4.2.</strong> February</a></li><li class="chapter-item "><a href="../updates/dated/2019/march.html"><strong aria-hidden="true">7.6.4.3.</strong> March</a></li><li class="chapter-item "><a href="../updates/dated/2019/april.html"><strong aria-hidden="true">7.6.4.4.</strong> April</a></li><li class="chapter-item "><a href="../updates/dated/2019/september.html"><strong aria-hidden="true">7.6.4.5.</strong> September</a></li><li class="chapter-item "><a href="../updates/dated/2019/december.html"><strong aria-hidden="true">7.6.4.6.</strong> December</a></li></ol></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../reading/index.html"><strong aria-hidden="true">8.</strong> Reading archive</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../reading/2016/index.html"><strong aria-hidden="true">8.1.</strong> 2016</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../reading/2016/july.html"><strong aria-hidden="true">8.1.1.</strong> July</a></li><li class="chapter-item "><a href="../reading/2016/december.html"><strong aria-hidden="true">8.1.2.</strong> December</a></li></ol></li><li class="chapter-item "><a href="../reading/2017/index.html"><strong aria-hidden="true">8.2.</strong> 2017</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../reading/2017/january.html"><strong aria-hidden="true">8.2.1.</strong> January</a></li><li class="chapter-item "><a href="../reading/2017/february.html"><strong aria-hidden="true">8.2.2.</strong> February</a></li><li class="chapter-item "><a href="../reading/2017/march.html"><strong aria-hidden="true">8.2.3.</strong> March</a></li><li class="chapter-item "><a href="../reading/2017/april.html"><strong aria-hidden="true">8.2.4.</strong> April</a></li><li class="chapter-item "><a href="../reading/2017/may.html"><strong aria-hidden="true">8.2.5.</strong> May</a></li><li class="chapter-item "><a href="../reading/2017/june.html"><strong aria-hidden="true">8.2.6.</strong> June</a></li><li class="chapter-item "><a href="../reading/2017/july.html"><strong aria-hidden="true">8.2.7.</strong> July</a></li><li class="chapter-item "><a href="../reading/2017/august.html"><strong aria-hidden="true">8.2.8.</strong> August</a></li><li class="chapter-item "><a href="../reading/2017/september.html"><strong aria-hidden="true">8.2.9.</strong> September</a></li><li class="chapter-item "><a href="../reading/2017/october.html"><strong aria-hidden="true">8.2.10.</strong> October</a></li><li class="chapter-item "><a href="../reading/2017/november.html"><strong aria-hidden="true">8.2.11.</strong> November</a></li><li class="chapter-item "><a href="../reading/2017/december.html"><strong aria-hidden="true">8.2.12.</strong> December</a></li></ol></li><li class="chapter-item "><a href="../reading/2018/index.html"><strong aria-hidden="true">8.3.</strong> 2018</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../reading/2018/january.html"><strong aria-hidden="true">8.3.1.</strong> January</a></li><li class="chapter-item "><a href="../reading/2018/february.html"><strong aria-hidden="true">8.3.2.</strong> February</a></li><li class="chapter-item "><a href="../reading/2018/march.html"><strong aria-hidden="true">8.3.3.</strong> March</a></li><li class="chapter-item "><a href="../reading/2018/april.html"><strong aria-hidden="true">8.3.4.</strong> April</a></li><li class="chapter-item "><a href="../reading/2018/may.html"><strong aria-hidden="true">8.3.5.</strong> May</a></li><li class="chapter-item "><a href="../reading/2018/june.html"><strong aria-hidden="true">8.3.6.</strong> June</a></li><li class="chapter-item "><a href="../reading/2018/july.html"><strong aria-hidden="true">8.3.7.</strong> July</a></li><li class="chapter-item "><a href="../reading/2018/august.html"><strong aria-hidden="true">8.3.8.</strong> August</a></li><li class="chapter-item "><a href="../reading/2018/september.html"><strong aria-hidden="true">8.3.9.</strong> September</a></li><li class="chapter-item "><a href="../reading/2018/october.html"><strong aria-hidden="true">8.3.10.</strong> October</a></li><li class="chapter-item "><a href="../reading/2018/november.html"><strong aria-hidden="true">8.3.11.</strong> November</a></li><li class="chapter-item "><a href="../reading/2018/december.html"><strong aria-hidden="true">8.3.12.</strong> December</a></li></ol></li><li class="chapter-item "><a href="../reading/2019/index.html"><strong aria-hidden="true">8.4.</strong> 2019</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../reading/2019/january.html"><strong aria-hidden="true">8.4.1.</strong> January</a></li><li class="chapter-item "><a href="../reading/2019/february.html"><strong aria-hidden="true">8.4.2.</strong> February</a></li><li class="chapter-item "><a href="../reading/2019/march.html"><strong aria-hidden="true">8.4.3.</strong> March</a></li><li class="chapter-item "><a href="../reading/2019/april.html"><strong aria-hidden="true">8.4.4.</strong> April</a></li><li class="chapter-item "><a href="../reading/2019/may.html"><strong aria-hidden="true">8.4.5.</strong> May</a></li><li class="chapter-item "><a href="../reading/2019/june.html"><strong aria-hidden="true">8.4.6.</strong> June</a></li><li class="chapter-item "><a href="../reading/2019/july.html"><strong aria-hidden="true">8.4.7.</strong> July</a></li><li class="chapter-item "><a href="../reading/2019/august.html"><strong aria-hidden="true">8.4.8.</strong> August</a></li><li class="chapter-item "><a href="../reading/2019/september.html"><strong aria-hidden="true">8.4.9.</strong> September</a></li><li class="chapter-item "><a href="../reading/2019/october.html"><strong aria-hidden="true">8.4.10.</strong> October</a></li><li class="chapter-item "><a href="../reading/2019/november.html"><strong aria-hidden="true">8.4.11.</strong> November</a></li><li class="chapter-item "><a href="../reading/2019/december.html"><strong aria-hidden="true">8.4.12.</strong> December</a></li></ol></li><li class="chapter-item "><a href="../reading/2020/index.html"><strong aria-hidden="true">8.5.</strong> 2020</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../reading/2020/january.html"><strong aria-hidden="true">8.5.1.</strong> January</a></li><li class="chapter-item "><a href="../reading/2020/february.html"><strong aria-hidden="true">8.5.2.</strong> February</a></li><li class="chapter-item "><a href="../reading/2020/march-june.html"><strong aria-hidden="true">8.5.3.</strong> March—June</a></li><li class="chapter-item "><a href="../reading/2020/july.html"><strong aria-hidden="true">8.5.4.</strong> July</a></li><li class="chapter-item "><a href="../reading/2020/august-december.html"><strong aria-hidden="true">8.5.5.</strong> August—December</a></li></ol></li><li class="chapter-item "><a href="../reading/2021/index.html"><strong aria-hidden="true">8.6.</strong> 2021</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../reading/2021/january-may.html"><strong aria-hidden="true">8.6.1.</strong> First semester</a></li><li class="chapter-item "><a href="../reading/2021/june-november.html"><strong aria-hidden="true">8.6.2.</strong> Second semester</a></li></ol></li><li class="chapter-item "><a href="../reading/2022/index.html"><strong aria-hidden="true">8.7.</strong> 2022</a></li><li class="chapter-item "><a href="../reading/2023/index.html"><strong aria-hidden="true">8.8.</strong> 2023</a></li><li class="chapter-item "><a href="../reading/2024/index.html"><strong aria-hidden="true">8.9.</strong> 2024</a></li></ol></li><li class="chapter-item expanded "><a href="../deprecated/index.html"><strong aria-hidden="true">9.</strong> Deprecated content</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../deprecated/blanket.html"><strong aria-hidden="true">9.1.</strong> Blanket license</a></li><li class="chapter-item "><a href="../info/keys.html"><strong aria-hidden="true">9.2.</strong> Cryptographic keys</a></li><li class="chapter-item "><div><strong aria-hidden="true">9.3.</strong> Outdated</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../technical/no-time-for-chrono.html"><strong aria-hidden="true">9.3.1.</strong> No Time for Chrono</a></li><li class="chapter-item "><a href="../technical/dhall-review.html"><strong aria-hidden="true">9.3.2.</strong> Dhall: not quite it</a></li><li class="chapter-item "><a href="../deprecated/outdated/modern-systems-languages.html"><strong aria-hidden="true">9.3.3.</strong> Modern systems languages</a></li><li class="chapter-item "><a href="../deprecated/outdated/soft-limits-meaningful-cuts.html"><strong aria-hidden="true">9.3.4.</strong> Soft limits and meaningful content cuts</a></li><li class="chapter-item "><a href="../deprecated/outdated/bruteforcing-the-devil.html"><strong aria-hidden="true">9.3.5.</strong> Bruteforcing the Devil</a></li><li class="chapter-item "><a href="../deprecated/outdated/lighting-up-rust-with-neon.html"><strong aria-hidden="true">9.3.6.</strong> Lighting up Rust with Neon</a></li></ol></li><li class="chapter-item "><div><strong aria-hidden="true">9.4.</strong> Unheld</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../deprecated/unheld/sidebar.html"><strong aria-hidden="true">9.4.1.</strong> SIDEBAR</a></li><li class="chapter-item "><a href="../deprecated/unheld/a-thought-on-fanfiction.html"><strong aria-hidden="true">9.4.2.</strong> A thought on fanfiction</a></li><li class="chapter-item "><div><strong aria-hidden="true">9.4.3.</strong> Identity</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../deprecated/unheld/not-coming.html"><strong aria-hidden="true">9.4.3.1.</strong> This is not a coming out</a></li><li class="chapter-item "><a href="../deprecated/unheld/guy-adjacent.html"><strong aria-hidden="true">9.4.3.2.</strong> Guy-Adjacent</a></li><li class="chapter-item "><a href="../deprecated/unheld/my-words.html"><strong aria-hidden="true">9.4.3.3.</strong> My Words</a></li></ol></li><li class="chapter-item "><a href="../musings/ai.html"><strong aria-hidden="true">9.4.4.</strong> On generative AI for programming Rust</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../deprecated/unheld/check-labels.html"><strong aria-hidden="true">9.4.4.1.</strong> Check all applicable labels</a></li></ol></li></ol></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Félix Saparelli</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/passcod/blook" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="a-little-elegant-state-machine-with-async-generators"><a class="header" href="#a-little-elegant-state-machine-with-async-generators">A little elegant state machine with Async Generators</a></h1>
<blockquote>
<p>2 February 2018</p>
</blockquote>
<p>Today at work I made this up:</p>
<pre><code class="language-js">async function* init_process (steps) {
   for (let step of steps) {
      while (true) {
         try {
            await step.run()
            break
         } catch (error) {
            handle_error({ step, error })
            yield
         }
      }
   }
}
</code></pre>
<p>What this does is it takes a list of <code>steps</code>, which are async tasks (in our
case a request and some processing), runs through them, and if there is an
error at some point it hands back to the caller… and then the caller can
choose to <em>retry the failed step and go on</em>.</p>
<p>All in 10 lines of code.</p>
<p>Beyond brevity, what I like about this code is that as long as you know the
behaviour of an async generator, of <code>break</code> inside a loop, of a <code>try</code>-<code>catch</code> —
which are all, to the possible exception of the async generator, fairly
elemental language structures — you can understand what this little machine
does simply by running through it line by line, iteration by iteration.</p>
<p>Here’s how you’d use this:</p>
<pre><code class="language-js">// load the steps, do some prep work...

// Prepare the little machine
const process = init_process(steps)

// Hook up the retry button
$('.retry-button').click(() =&gt; process.next())

// Start it up
process.next()
</code></pre>
<p>And that’s it!</p>
<hr />
<p>Let’s run through this a bit:</p>
<ol>
<li>
<p><code>async function* init_process (steps) {</code></p>
<p>This is an Async Generator that takes a list of <code>steps</code>. Generators, and
Async Generators, gets their arguments and then start <em>frozen</em>. They don’t
do any processing until you first call <code>.next()</code>.</p>
<p>An Async Generator is just a Generator! All it does special is that you can
use <code>await</code> inside it and if you want the results of what it <code>yield</code>s, you
have to await those. (But we don’t use that here so you don’t even need to
keep that in mind.) There’s no extra magic.</p>
</li>
<li>
<p><code>for (let step of steps) {</code></p>
<p>We’re going to iterate through all the steps, one at a time.</p>
</li>
<li>
<p><code>while (true) {</code></p>
<p>This is the first “aha!” moment. To make it possible to <em>retry</em> the current,
failed, step, we start an infinite loop. If we have a success, we can break
out of it, dropping back into… the <code>for</code> loop, and thus continuing onto
the next step. If we have a failure, we <em>don’t</em> break out, and the <code>while</code>
loop will naturally start that step over.</p>
</li>
<li>
<p><code>try { await step.run(); break</code></p>
<p>We <code>try</code> the <code>step.run()</code>, and then we <code>break</code>. Because of the way
exceptions work, <code>break</code> will <em>only run if nothing was thrown</em>. That is, if
<code>step.run()</code> ended successfully.</p>
</li>
<li>
<p><code>catch (error) { handle_error({ step, error })</code></p>
<p>We want to immediately handle the error. We <em>could</em> <code>yield</code> the error and
let the caller handle it, but this way there’s no need for an extra wrapping
function: we can just call <code>process.next()</code> to start and resume the machine,
without needing to care about its output.</p>
</li>
<li>
<p><code>yield</code></p>
<p>The piece of magic that brings it all together. If and when we get to that,
we <em>freeze</em> the generator state and hand back execution to the caller. It’s
now up to it to tell the little machine to continue, and it can do that at
any time. There’s no need for complex state management, of preserving and
restoring progress: the language itself is taking care of it.</p>
</li>
<li>
<p>Outside: <code>process.next()</code> (the first time)</p>
<p>Recall that the Generator starts <em>frozen</em> (see 1). The first thing we do is
call <code>next()</code>, and that unfreezes the machine. It starts processing steps,
and eventually will either get to the end, or stop at an error.</p>
</li>
<li>
<p>To retry: <code>process.next()</code></p>
<p>When we hit a snag, <code>handle_error()</code> does its job of telling the user and
figuring out problems… and then it can choose to display a retry button.
Or maybe it will want to automatically retry a step if it deems it safe to
do so. Or maybe the error was very bad, and it just wants to abort. It can
do all these things, and it can take its time: the little machine will wait
patiently until it’s told to get going again.</p>
</li>
</ol>
<p>And that’s all there is to it!</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../technical/exploring-wasm.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../musings/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../technical/exploring-wasm.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../musings/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
