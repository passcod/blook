<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>No Time for Chrono - Félix Saparelli</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Félix Saparelli</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/passcod/blook" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="no-time-for-chrono"><a class="header" href="#no-time-for-chrono">No Time for Chrono</a></h1>
<blockquote>
<p>October 2021</p>
</blockquote>
<p>TL;DR: <a href="https://rustsec.org/advisories/RUSTSEC-2020-0071">Time 0.1 and 0.2 have a security notice</a> about use of the <code>localtime_r</code>
libc function, and <a href="https://rustsec.org/advisories/RUSTSEC-2020-0159">Chrono has a related notice</a>, both issued in November 2020.
While <a href="https://github.com/time-rs/time/issues/293">Time has a mitigation in place</a>, <a href="https://github.com/chronotope/chrono/issues/499">Chrono doesn’t and doesn’t plan to</a>.
The security issue is very specific and can be mitigated through your own efforts; there’s also some
controversy on if it is an issue at all. The Time crate has evolved a lot in the past few years and
its 0.3 release has a lot of APIs that Chrono is used for; thus it is possible for many, but not
all, Chrono users to switch to Time 0.3; this could have some additional benefit.</p>
<ul>
<li><a href="#the-security-issue">The security issue</a>
<ul>
<li><a href="#advisory-notices">Advisory notices</a></li>
<li><a href="#localtime_r-and-setenv"><code>localtime_r</code> and <code>setenv</code></a></li>
<li><a href="#the-counter-view">The counter view</a></li>
</ul>
</li>
<li><a href="#replacing-chrono">Replacing Chrono</a>
<ul>
<li><a href="#chronic-pains">Chronic pains</a></li>
<li><a href="#time-03">Time 0.3</a></li>
</ul>
</li>
</ul>
<h2 id="the-security-issue"><a class="header" href="#the-security-issue">The security issue</a></h2>
<p>From the advisory:</p>
<blockquote>
<p>Unix-like operating systems may segfault due to dereferencing a dangling pointer in specific
circumstances. This requires an environment variable to be set in a different thread than the
affected functions. This may occur without the user’s knowledge, notably in a third-party library.</p>
<p>Non-Unix targets (including Windows and wasm) are unaffected.</p>
</blockquote>
<h3 id="advisory-notices"><a class="header" href="#advisory-notices">Advisory notices</a></h3>
<ul>
<li>RustSec:
<ul>
<li><a href="https://rustsec.org/advisories/RUSTSEC-2020-0071">RUSTSEC-2020-0071</a> on Time 0.1 and 0.2.7–0.2.22</li>
<li><a href="https://rustsec.org/advisories/RUSTSEC-2020-0159">RUSTSEC-2020-0159</a> on Chrono</li>
</ul>
</li>
<li>Mitre:
<ul>
<li><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-26235">CVE-2020-26235</a></li>
</ul>
</li>
<li>GitHub:
<ul>
<li><a href="https://github.com/time-rs/time/security/advisories/GHSA-wcg3-cvx6-7396">GHSA-wcg3-cvx6-7396</a></li>
</ul>
</li>
</ul>
<h3 id="localtime_r-and-setenv"><a class="header" href="#localtime_r-and-setenv"><code>localtime_r</code> and <code>setenv</code></a></h3>
<p>From the <a href="https://man.archlinux.org/man/core/man-pages/localtime_r.3.en">manpage</a>, edited for length:</p>
<blockquote>
<p>The <code>localtime_r()</code> function converts the calendar time <code>timep</code> to broken-down time
representation, expressed relative to the user’s specified timezone. The function acts as if it
called <code>tzset(3)</code> and provides information about the current timezone, the difference between
Coordinated Universal Time (UTC) and local standard time in seconds, and whether daylight savings
time rules apply during some part of the year.</p>
</blockquote>
<p>Meanwhile, <a href="https://man.archlinux.org/man/core/man-pages/setenv.3.en">setenv</a>:</p>
<blockquote>
<p>…adds the variable <code>name</code> to the environment with the value <code>value</code>…</p>
</blockquote>
<p>The issue occurs when the environment of a program is modified (chiefly with <code>setenv</code>) at the same
time that <code>localtime_r</code> is used; in those cases, a segfault may be observed.</p>
<p><code>localtime_r</code> is a fairly complex beast, which interfaces with the system’s timezone files and
settings to provide localtime information and conversion. It is a very useful function that is used
pretty much everywhere that needs to interact with local/utc time and timezones. Handling timezones
is largely regarded as all programmers’ bane; replacing this function with one that does not have
the behaviour is a <a href="https://github.com/time-rs/time/issues/293#issuecomment-909009716">potentially massive endeavour</a>. Over on IRLO, Tony Arcieri
<a href="https://internals.rust-lang.org/t/synchronized-ffi-access-to-posix-environment-variable-functions/15475">provides a summary of the Rust side of this issue</a>.</p>
<p>Time has mitigated the issue by removing the calls to <code>localtime_r</code>, returning errors in 0.2 and 0.3
<a href="https://github.com/time-rs/time/blame/4eebedd48c505fb7b042ad8aff8ad7665c5545ed/src/utc_offset.rs#L330-L332">unless a custom <code>cfg</code> is passed to the compiler</a>. That does mean that if you
<em>do</em> want that information, you’re out of luck unless you (as an application) or all your end-users
(as a library) enable that custom configuration.</p>
<h3 id="the-counter-view"><a class="header" href="#the-counter-view">The counter view</a></h3>
<p><a href="https://twitter.com/RichFelker/status/1450300830381445121">Rich Felker (author of musl) has another view.</a> He argues that the issue is not in
calling the <code>localtime_r</code> function, but in modifying the environment. The environment ought to be
immutable, and it is somewhat well known in other large projects that the footgun exists:</p>
<ul>
<li><a href="https://github.com/JuliaLang/julia/issues/34726#issuecomment-584727732">In the Julia language, also featuring Felker</a></li>
<li><a href="https://yizhang82.dev/set-environment-variable">In C#’s CoreCLR</a></li>
<li><a href="https://github.com/xianyi/OpenBLAS/issues/716">In OpenBLAS</a></li>
<li><a href="https://sourceware.org/bugzilla/show_bug.cgi?id=15607#c4">In GNOME</a></li>
<li><a href="https://austingroupbugs.net/view.php?id=188">In the POSIX standard</a></li>
</ul>
<p>This issue is even known to the Rust project, with <a href="https://github.com/rust-lang/rust/pull/24741">a documentation PR in 2015(!) adding cautionary
language to the <code>std::env::set_var</code> function</a>.</p>
<p>I don’t have nearly the same amount of knowledge in this issue, but for the record, and despite the
sections below, I do <em>agree</em> with the view that the environment should be considered read-only.
Perhaps a clippy lint could be added.</p>
<h2 id="replacing-chrono"><a class="header" href="#replacing-chrono">Replacing Chrono</a></h2>
<p>Regardless of the previous discussion, there are other issues around usage of Chrono.</p>
<h3 id="chronic-pains"><a class="header" href="#chronic-pains">Chronic pains</a></h3>
<p>Its last release at writing, 0.4.19, was <a href="https://github.com/chronotope/chrono/releases/tag/v0.4.19">more than a year ago</a>. Issues are piling
up. It’s still on edition 2015 (which to be clear isn’t really an issue, but more of an indicator).</p>
<p>It could just be that the crate is considered finished (the docs <em>do</em> describe it as
“feature-complete”).</p>
<p>Or it may be that maintainers have mostly checked out. (No fault on the maintainers! I’ve done the
same with Notify, once.)</p>
<p>If you’re fine with this, and you’re confident that you (and your dependencies) aren’t writing to
the environment, then you can keep on using Chrono. There is, however, a viable alternative now:</p>
<h3 id="time-03"><a class="header" href="#time-03">Time 0.3</a></h3>
<p><a href="https://github.com/time-rs/time/blob/main/CHANGELOG.md#030-2021-07-30">Time’s 0.3 release adds many APIs</a>, which cover a large amount of the surface that Chrono
is used for:</p>
<ul>
<li>No-alloc mode</li>
<li>The <code>Month</code> type</li>
<li>Calendar/Ordinal/ISO/Julian conversions</li>
<li>Large dates (beyond +/- 9999 years)</li>
<li>Parsing and serde support</li>
</ul>
<p>There are also some features which are only supported by newer Time, not by Chrono:</p>
<ul>
<li><code>const</code> functions</li>
<li>the <code>datetime!</code> macro for constructing datetimes at compile-time</li>
<li>Serialising non-ISO8601 representations</li>
<li>Random dates/times</li>
<li><a href="https://docs.rs/quickcheck">QuickCheck</a> support</li>
</ul>
<p>Therefore, you can now reasonable replace Chrono with Time!</p>
<p>(In the future I hope to provide a “quick migration guide” here. For now, it’s left to the reader!)</p>
<!-- ! vim: tw=100
-->

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../info/keys.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../technical/dhall-review.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../info/keys.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../technical/dhall-review.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
